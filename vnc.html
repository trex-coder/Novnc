<!DOCTYPE html>
<html lang="en" class="noVNC_loading">
<head>

    <!--
    noVNC example: simple example using default UI
    Copyright (C) 2019 The noVNC authors
    noVNC is licensed under the MPL 2.0 (see LICENSE.txt)
    This file is licensed under the 2-Clause BSD license (see LICENSE.txt).

    Connect parameters are provided in query string:
        http://example.com/?host=HOST&port=PORT&encrypt=1
    or the fragment:
        http://example.com/#host=HOST&port=PORT&encrypt=1
    -->
    <title>noVNC</title>

    <link rel="icon" type="image/x-icon" href="app/images/icons/novnc.ico">
    <meta name="theme-color" content="#313131">

    <!-- Apple iOS Safari settings -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- @2x -->
    <link rel="apple-touch-icon" sizes="40x40" type="image/png" href="app/images/icons/novnc-ios-40.png">
    <link rel="apple-touch-icon" sizes="58x58" type="image/png" href="app/images/icons/novnc-ios-58.png">
    <link rel="apple-touch-icon" sizes="80x80" type="image/png" href="app/images/icons/novnc-ios-80.png">
    <link rel="apple-touch-icon" sizes="120x120" type="image/png" href="app/images/icons/novnc-ios-120.png">
    <link rel="apple-touch-icon" sizes="152x152" type="image/png" href="app/images/icons/novnc-ios-152.png">
    <link rel="apple-touch-icon" sizes="167x167" type="image/png" href="app/images/icons/novnc-ios-167.png">
    <!-- @3x -->
    <link rel="apple-touch-icon" sizes="60x60" type="image/png" href="app/images/icons/novnc-ios-60.png">
    <link rel="apple-touch-icon" sizes="87x87" type="image/png" href="app/images/icons/novnc-ios-87.png">
    <link rel="apple-touch-icon" sizes="120x120" type="image/png" href="app/images/icons/novnc-ios-120.png">
    <link rel="apple-touch-icon" sizes="180x180" type="image/png" href="app/images/icons/novnc-ios-180.png">

    <!-- Stylesheets -->
    <link rel="stylesheet" href="app/styles/constants.css">
    <link rel="stylesheet" href="app/styles/base.css">
    <link rel="stylesheet" href="app/styles/custom.css">
    <link rel="stylesheet" href="app/styles/input.css">
    <!-- LoudWave VNC Viewer UI Styles -->
    <link rel="stylesheet" href="app/styles/vnc-viewer.css">

    <!-- Images that will later appear via CSS -->
    <link rel="preload" as="image" href="app/images/info.svg">
    <link rel="preload" as="image" href="app/images/error.svg">
    <link rel="preload" as="image" href="app/images/warning.svg">

    <script type="module" crossorigin="anonymous" src="app/error-handler.js"></script>

    <script type="module">
        import UI from "./app/ui.js";
        import * as Log from './core/util/logging.js';

        let response;

        let defaults = {};
        let mandatory = {};

        // Default settings will be loaded from defaults.json. Mandatory
        // settings will be loaded from mandatory.json, which the user
        // cannot change.

        try {
            response = await fetch('./defaults.json');
            if (!response.ok) {
                throw Error("" + response.status + " " + response.statusText);
            }

            defaults = await response.json();
        } catch (err) {
            Log.Error("Couldn't fetch defaults.json: " + err);
        }

        try {
            response = await fetch('./mandatory.json');
            if (!response.ok) {
                throw Error("" + response.status + " " + response.statusText);
            }

            mandatory = await response.json();
        } catch (err) {
            Log.Error("Couldn't fetch mandatory.json: " + err);
        }

        // You can also override any defaults you need here:
        //
        // defaults['host'] = 'vnc.example.com';

        // Or force a specific setting, preventing the user from
        // changing it:
        //
        // mandatory['view_only'] = true;

        // See docs/EMBEDDING.md for a list of possible settings.

        console.log('[VNC] Starting UI initialization...');
        
        // Initialize UI and hook into RFB for LoudWave integration
        await UI.start({ settings: { defaults: defaults,
                                       mandatory: mandatory } });
        
        console.log('[VNC] UI.start completed, UI.rfb ready');
        
        // Expose UI.rfb to window.rfb for LoudWave integration access
        // and set up RFB connection monitoring
        let lastRFBState = false;
        let sessionWelcomeShown = false; // Session-specific flag (not persistent)
        console.log('[VNC] Initializing RFB monitoring');
        
        const monitorRFB = setInterval(() => {
            // Check if UI.rfb exists and has a different connection state than last check
            const isConnected = (UI.rfb && UI.rfb.connected) ? true : false;
            
            // Expose to window for LoudWave integration
            window.rfb = UI.rfb;
            
            // If connection state changed to connected, notify integration
            if (isConnected && !lastRFBState) {
                console.log('[VNC] RFB connected, LoudWave integration ready');
                
                // Notify LoudWave integration
                window.dispatchEvent(new CustomEvent('rfbCreated', { detail: UI.rfb }));
                
                lastRFBState = true;
            } else if (!isConnected && lastRFBState) {
                // Connection was lost
                lastRFBState = false;
                console.log('[VNC] RFB disconnected');
            }
        }, 300);
        
        // Clear check after 120 seconds (2 minutes for reliability)
        setTimeout(() => {
            clearInterval(monitorRFB);
            console.log('[VNC] RFB connection monitor stopped');
        }, 120000);
    </script>

    <script>
      // Detect if running in a WebView (Android/iOS/Sketchware Pro)
      function isWebView() {
        var standalone = window.navigator.standalone;
        var userAgent = window.navigator.userAgent || '';
        var isAndroidWebView = /; wv\)/.test(userAgent) || /Sketchware/i.test(userAgent);
        var isIOSWebView = (
          /(iPhone|iPod|iPad).*AppleWebKit(?!.*Safari)/i.test(userAgent)
        );
        return (standalone === false || isAndroidWebView || isIOSWebView);
      }
      document.addEventListener('DOMContentLoaded', function() {
        if (isWebView()) {
          // Hide fullscreen button in control bar
          var fsBtn = document.getElementById('noVNC_fullscreen_button');
          if (fsBtn) fsBtn.style.display = 'none';
          // Hide fullscreen button in quick menu
          var fsQuickBtn = document.getElementById('noVNC_quick_fullscreen');
          if (fsQuickBtn) fsQuickBtn.style.display = 'none';
        }
        
        // Menu toggle is now handled by the setupQuickMenuPanel function in ui.js
        // This prevents duplicate event handlers that cause menu toggle issues
      });
    </script>
</head>

<body>
    <!-- LoudWave VNC Viewer UI (Above noVNC) -->
    <div class="vnc-container" id="vncContainer">
        <canvas id="vncCanvas"></canvas>
        
        <!-- Touch Indicator -->
        <div class="touch-indicator" id="touchIndicator"></div>
        
        <!-- Back Button (Floating) -->
        <button class="floating-back-btn" onclick="goBack()">
            <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
        </button>
    </div>

    <!-- Glassy Pill Navigation -->
    <div class="pill-nav hidden-completely" id="pillNav">
        <div class="pill-handle"></div>
        
        <!-- Server Info Header -->
        <div class="pill-server-info">
            <div class="ping-indicator" id="pingIndicator" title="Latency">
                <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M5 12.55a11 11 0 0 1 14.08 0"></path>
                    <path d="M1.42 9a16 16 0 0 1 21.16 0"></path>
                    <path d="M8.53 16.11a6 6 0 0 1 6.95 0"></path>
                    <line x1="12" y1="20" x2="12.01" y2="20"></line>
                </svg>
                <span class="ping-ms" id="pingMs" style="font-size: 11px; margin-left: 4px; color: #66ea9b;">--ms</span>
            </div>
            <div class="server-text-info">
                <span class="connection-status-pill" id="connectionStatus">Disconnected</span>
            </div>
        </div>
        
        <div class="pill-buttons">
            <button class="pill-btn" onclick="toggleKeyboardLW()" title="Keyboard">
                <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="2" y="6" width="20" height="12" rx="2"></rect>
                    <line x1="6" y1="10" x2="6.01" y2="10"></line>
                    <line x1="10" y1="10" x2="10.01" y2="10"></line>
                    <line x1="14" y1="10" x2="14.01" y2="10"></line>
                    <line x1="18" y1="10" x2="18.01" y2="10"></line>
                    <line x1="8" y1="14" x2="16" y2="14"></line>
                </svg>
            </button>

            <button class="pill-btn" onclick="sendCtrlAltDelLW()" title="Ctrl+Alt+Del">
                <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="9" y1="9" x2="15" y2="15"></line>
                    <line x1="15" y1="9" x2="9" y2="15"></line>
                </svg>
            </button>

            <button class="pill-btn" onclick="openInfoMenuLW()" title="Info">
                <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <path d="M12 16v-4"></path>
                    <path d="M12 8h.01"></path>
                </svg>
            </button>

            <button class="pill-btn" onclick="toggleFullscreenLW()" title="Fullscreen">
                <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path>
                </svg>
            </button>

            <button class="pill-btn" onclick="openQualitySettingsLW()" title="Quality Settings">
                <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polygon points="23 7 16 12 23 17 23 7"></polygon>
                    <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
                </svg>
            </button>

            <button class="pill-btn disconnect-btn" onclick="disconnectLW()" title="Disconnect">
                <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                    <polyline points="16 17 21 12 16 7"></polyline>
                    <line x1="21" y1="12" x2="9" y2="12"></line>
                </svg>
            </button>
        </div>
    </div>

    <!-- Info Side Menu -->
    <div class="side-menu" id="sideMenu">
        <div class="menu-content">
            <div class="menu-header">
                <h3>Connection Info</h3>
                <button class="close-menu-btn" onclick="closeInfoMenuLW()">
                    <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>

            <div class="menu-item">
                <div class="menu-label">Server</div>
                <div class="menu-value" id="menuServer">Remote Server</div>
            </div>

            <div class="menu-item">
                <div class="menu-label">Resolution</div>
                <div class="menu-value" id="menuResolution">1920 x 1080</div>
            </div>

            <div class="menu-item">
                <div class="menu-label">Connection Quality</div>
                <div class="menu-value quality-good" id="menuQuality">Excellent</div>
            </div>

            <div class="menu-item">
                <div class="menu-label">Latency</div>
                <div class="menu-value" id="menuLatency">--ms</div>
            </div>

            <div class="menu-divider"></div>

            <button class="menu-action-btn" onclick="showStatsLW()">
                <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="20" x2="12" y2="10"></line>
                    <line x1="18" y1="20" x2="18" y2="4"></line>
                    <line x1="6" y1="20" x2="6" y2="16"></line>
                </svg>
                <span>Performance Stats</span>
            </button>
        </div>
    </div>

    <!-- Quality Settings Dialog -->
    <div class="dialog-overlay" id="qualityDialog">
        <div class="dialog quality-dialog">
            <div class="dialog-header">
                <h3>Video Quality</h3>
                <button class="close-menu-btn" onclick="closeQualitySettingsLW()">
                    <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            
            <div class="quality-options">
                <button class="quality-option active" onclick="setQualityLW('high')">
                    <div class="quality-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7 10 12 15 17 10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                    </div>
                    <div class="quality-info">
                        <div class="quality-title">High Quality</div>
                        <div class="quality-desc">Best visual quality, higher bandwidth</div>
                    </div>
                </button>

                <button class="quality-option" onclick="setQualityLW('medium')">
                    <div class="quality-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="8" x2="12" y2="12"></line>
                            <line x1="12" y1="16" x2="12.01" y2="16"></line>
                        </svg>
                    </div>
                    <div class="quality-info">
                        <div class="quality-title">Medium Quality</div>
                        <div class="quality-desc">Balanced quality and performance</div>
                    </div>
                </button>

                <button class="quality-option" onclick="setQualityLW('low')">
                    <div class="quality-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="17 8 12 3 7 8"></polyline>
                            <line x1="12" y1="3" x2="12" y2="15"></line>
                        </svg>
                    </div>
                    <div class="quality-info">
                        <div class="quality-title">Low Quality</div>
                        <div class="quality-desc">Faster performance, low bandwidth</div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Virtual Keyboard -->
    <div class="virtual-keyboard" id="virtualKeyboard">
        <div class="keyboard-header">
            <span>Virtual Keyboard</span>
            <button class="close-keyboard-btn" onclick="toggleKeyboardLW()">
                <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="keyboard-content">
            <div class="keyboard-row">
                <button class="key">1</button>
                <button class="key">2</button>
                <button class="key">3</button>
                <button class="key">4</button>
                <button class="key">5</button>
                <button class="key">6</button>
                <button class="key">7</button>
                <button class="key">8</button>
                <button class="key">9</button>
                <button class="key">0</button>
            </div>
            <div class="keyboard-row">
                <button class="key">Q</button>
                <button class="key">W</button>
                <button class="key">E</button>
                <button class="key">R</button>
                <button class="key">T</button>
                <button class="key">Y</button>
                <button class="key">U</button>
                <button class="key">I</button>
                <button class="key">O</button>
                <button class="key">P</button>
            </div>
            <div class="keyboard-row">
                <button class="key">A</button>
                <button class="key">S</button>
                <button class="key">D</button>
                <button class="key">F</button>
                <button class="key">G</button>
                <button class="key">H</button>
                <button class="key">J</button>
                <button class="key">K</button>
                <button class="key">L</button>
            </div>
            <div class="keyboard-row">
                <button class="key special">Shift</button>
                <button class="key">Z</button>
                <button class="key">X</button>
                <button class="key">C</button>
                <button class="key">V</button>
                <button class="key">B</button>
                <button class="key">N</button>
                <button class="key">M</button>
                <button class="key special">âŒ«</button>
            </div>
            <div class="keyboard-row">
                <button class="key special">Ctrl</button>
                <button class="key special">Alt</button>
                <button class="key spacebar">Space</button>
                <button class="key special">Enter</button>
            </div>
        </div>
    </div>

    <!-- Disconnect Dialog -->
    <div class="dialog-overlay" id="disconnectDialog">
        <div class="dialog">
            <div class="dialog-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                    <polyline points="16 17 21 12 16 7"></polyline>
                    <line x1="21" y1="12" x2="9" y2="12"></line>
                </svg>
            </div>
            <h3>Disconnect Session?</h3>
            <p>Are you sure you want to disconnect?</p>
            <div class="dialog-buttons">
                <button class="dialog-btn cancel" onclick="closeDisconnectDialogLW()">Cancel</button>
                <button class="dialog-btn confirm" onclick="confirmDisconnectLW()">Disconnect</button>
            </div>
        </div>
    </div>

    <!-- Welcome/Shortcut Info Dialog -->
    <div class="dialog-overlay" id="welcomeDialog">
        <div class="dialog">
            <div class="dialog-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"></path>
                    <path d="M12 16v-4"></path>
                    <path d="M12 8h.01"></path>
                </svg>
            </div>
            <h3>Remote Desktop Viewer</h3>
            <p style="text-align: center; margin-bottom: 16px;">
                <strong>Quick Tip:</strong><br>
                Press <kbd style="background: rgba(255,255,255,0.1); padding: 4px 8px; border-radius: 4px; font-family: monospace;">Ctrl + V</kbd> 
                to show/hide the control panel
            </p>
            <div class="dialog-buttons">
                <button class="dialog-btn confirm" onclick="closeWelcomeDialogLW()" style="width: 100%;">Okay, got it!</button>
            </div>
        </div>
    </div>

    <!-- Original noVNC Container (Below LoudWave UI) -->
    <div id="noVNC_container" class="noVNC_vcenter"></div>
    <div id="noVNC_fallback_error" class="noVNC_center">
        <div>
            <div>Connection Error</div>
            <br>
            <div id="noVNC_fallback_errormsg"></div>
        </div>
    </div>

    <!-- Modern overlay control bar -->
    <div id="noVNC_control_bar_anchor" class="noVNC_vcenter">
        <div id="noVNC_control_bar">
            <div id="noVNC_control_bar_handle" title="Hide/Show the control bar"><div></div></div>

            <div class="noVNC_scroll">
                <div class="noVNC_button_group">
                    <!-- Drag/Pan the viewport -->
                    <input type="image" alt="Drag" src="app/images/drag.svg"
                        id="noVNC_view_drag_button" class="noVNC_button noVNC_hidden"
                        title="Move/Drag viewport">

                    <!--noVNC touch device only buttons-->
                    <div id="noVNC_mobile_buttons">
                        <input type="image" alt="Keyboard" src="app/images/keyboard.svg"
            id="noVNC_keyboard_button" class="noVNC_button" title="Show keyboard"
            onclick="event.preventDefault(); return false;">
                    </div>
                </div>

                <!-- Extra manual keys -->
                <input type="image" alt="Extra keys" src="app/images/toggleextrakeys.svg"
                    id="noVNC_toggle_extra_keys_button" class="noVNC_button"
                    title="Show extra keys">
                <div class="noVNC_vcenter">
                <div id="noVNC_modifiers" class="noVNC_panel">
                    <input type="image" alt="Ctrl" src="app/images/ctrl.svg"
                        id="noVNC_toggle_ctrl_button" class="noVNC_button"
                        title="Toggle Ctrl">
                    <input type="image" alt="Alt" src="app/images/alt.svg"
                        id="noVNC_toggle_alt_button" class="noVNC_button"
                        title="Toggle Alt">
                    <input type="image" alt="Windows" src="app/images/windows.svg"
                        id="noVNC_toggle_windows_button" class="noVNC_button"
                        title="Toggle Windows">
                    <input type="image" alt="Tab" src="app/images/tab.svg"
                        id="noVNC_send_tab_button" class="noVNC_button"
                        title="Send Tab">
                    <input type="image" alt="Esc" src="app/images/esc.svg"
                        id="noVNC_send_esc_button" class="noVNC_button"
                        title="Send Escape">
                    <input type="image" alt="Ctrl+Alt+Del" src="app/images/ctrlaltdel.svg"
                        id="noVNC_send_ctrl_alt_del_button" class="noVNC_button"
                        title="Send Ctrl-Alt-Del">
                </div>
                </div>

                <!-- Shutdown/Reboot -->
                <input type="image" alt="Shutdown/Reboot" src="app/images/power.svg"
                    id="noVNC_power_button" class="noVNC_button noVNC_hidden"
                    title="Shutdown/Reboot...">

                <!-- Clipboard -->
                <input type="image" alt="Clipboard" src="app/images/clipboard.svg"
                    id="noVNC_clipboard_button" class="noVNC_button noVNC_hidden"
                    title="Clipboard">

                <!-- Toggle fullscreen -->
                <input type="image" alt="Full screen" src="app/images/fullscreen.svg"
                    id="noVNC_fullscreen_button" class="noVNC_button noVNC_hidden"
                    title="Full screen">

                <!-- Settings panel with modern styling -->
                <input type="image" alt="Settings" src="app/images/settings.svg"
                    id="noVNC_settings_button" class="noVNC_button noVNC_hidden"
                    title="Settings">

                <!-- Connection controls -->
                <input type="image" alt="Disconnect" src="app/images/disconnect.svg"
                    id="noVNC_disconnect_button" class="noVNC_button"
                    title="Disconnect">

            </div>
        </div>
    </div> <!-- End of noVNC_control_bar -->

    <!-- Modern Quick Session Menu Overlay -->
    <div id="noVNC_quick_menu" class="noVNC_quick_menu">
        <div class="noVNC_quick_menu_content">
            <div class="noVNC_quick_menu_header">
                <span>Session Menu</span>
                <button id="noVNC_quick_menu_close" class="noVNC_quick_menu_close">&times;</button>
            </div>
            <div class="noVNC_quick_menu_group">
                <button id="noVNC_quick_connect" class="noVNC_quick_btn" title="Connect">
                  <span class="quick_menu_icon"> <!-- Link/plug icon -->
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M7.5 12.5L12.5 7.5" stroke="#3b82f6" stroke-width="2"/><rect x="2" y="11" width="7" height="7" rx="3.5" stroke="#3b82f6" stroke-width="2"/><rect x="11" y="2" width="7" height="7" rx="3.5" stroke="#3b82f6" stroke-width="2"/></svg>
                  </span>Connect
                </button>
                <button id="noVNC_quick_disconnect" class="noVNC_quick_btn" title="Disconnect">
                  <span class="quick_menu_icon">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M3 10h10M13 7l3 3-3 3" stroke="#ef4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><circle cx="10" cy="10" r="9" stroke="#ef4444" stroke-width="2" fill="none"/></svg>
                  </span>Disconnect
                </button>
            </div>
            <div class="noVNC_quick_menu_group">
                <button id="noVNC_quick_settings" class="noVNC_quick_btn" title="Settings">
                  <span class="quick_menu_icon">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><circle cx="10" cy="10" r="3" stroke="#3b82f6" stroke-width="2"/><path d="M10 2v2M10 16v2M2 10h2M16 10h2M4.93 4.93l1.42 1.42M14.07 14.07l1.42 1.42M4.93 15.07l1.42-1.42M14.07 5.93l1.42-1.42" stroke="#3b82f6" stroke-width="2"/></svg>
                  </span>Settings
                </button>
                <button id="noVNC_quick_keyboard" class="noVNC_quick_btn" title="Keyboard" onclick="event.preventDefault(); return false;">
                  <span class="quick_menu_icon">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><rect x="2" y="5" width="16" height="10" rx="2" stroke="#3b82f6" stroke-width="2"/><rect x="5" y="8" width="2" height="2" rx="1" fill="#3b82f6"/><rect x="9" y="8" width="2" height="2" rx="1" fill="#3b82f6"/><rect x="13" y="8" width="2" height="2" rx="1" fill="#3b82f6"/><rect x="7" y="12" width="6" height="2" rx="1" fill="#3b82f6"/></svg>
                  </span>Keyboard
                </button>
                <button id="noVNC_quick_clipboard" class="noVNC_quick_btn" title="Clipboard">
                  <span class="quick_menu_icon">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><rect x="5" y="3" width="10" height="14" rx="2" stroke="#3b82f6" stroke-width="2"/><rect x="7" y="1" width="6" height="4" rx="2" stroke="#3b82f6" stroke-width="2"/></svg>
                  </span>Clipboard
                </button>
            </div>
            <div class="noVNC_quick_menu_group">
                <button id="noVNC_quick_power" class="noVNC_quick_btn" title="Power">
                  <span class="quick_menu_icon">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M10 2v6" stroke="#ef4444" stroke-width="2"/><circle cx="10" cy="12" r="6" stroke="#ef4444" stroke-width="2"/></svg>
                  </span>Power
                </button>
                <button id="noVNC_quick_fullscreen" class="noVNC_quick_btn" title="Fullscreen">
                  <span class="quick_menu_icon">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M3 3h5v2H5v3H3V3zm14 0v5h-2V5h-3V3h5zm0 14h-5v-2h3v-3h2v5zm-14 0v-5h2v3h3v2H3z" fill="#3b82f6"/></svg>
                  </span>Fullscreen
                </button>
            </div>
        </div>
    </div>
    <!-- Modern Quick Menu Toggle Button -->
    <button id="noVNC_quick_menu_toggle" class="noVNC_quick_menu_toggle" aria-label="Open session menu">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7" rx="2"/><rect x="14" y="3" width="7" height="7" rx="2"/><rect x="14" y="14" width="7" height="7" rx="2"/><rect x="3" y="14" width="7" height="7" rx="2"/></svg>
    </button>

    <!-- Modern Settings Panel as Modal -->
    <div id="noVNC_modern_settings_modal" class="noVNC_modal_backdrop">
      <div id="noVNC_modern_settings" class="noVNC_modern_panel" tabindex="-1">
        <div class="noVNC_modern_panel_header">
          <span>Settings</span>
          <button id="noVNC_modern_settings_close" class="noVNC_modern_panel_close" aria-label="Close settings">&times;</button>
        </div>
        <div class="noVNC_modern_panel_content">
          <form id="noVNC_modern_settings_form">
            <div class="noVNC_setting_group">
              <label for="noVNC_setting_logging">Logging level</label>
              <select id="noVNC_setting_logging"></select>
            </div>
            <div class="noVNC_setting_group">
              <label for="noVNC_setting_quality">Quality <span id="noVNC_setting_quality_value">6</span></label>
              <input type="range" id="noVNC_setting_quality" min="0" max="9" value="6" step="1">
            </div>
            <div class="noVNC_setting_group">              <label for="noVNC_setting_scaling">Display mode</label>
              <select id="noVNC_setting_scaling">
                <option value="off">Full Screen</option>
                <option value="scale">Local Scaling</option>
                <option value="remote">Remote Resizing</option>
              </select>
            </div>
            <!-- Add other settings fields as needed here -->
          </form>
        </div>
      </div>
    </div>

    <!-- Modern Clipboard Panel as Modal -->
    <div id="noVNC_modern_clipboard_modal" class="noVNC_modal_backdrop">
      <div id="noVNC_modern_clipboard" class="noVNC_modern_panel" tabindex="-1">
        <div class="noVNC_modern_panel_header">
          <span>Clipboard</span>
          <button id="noVNC_modern_clipboard_close" class="noVNC_modern_panel_close" aria-label="Close clipboard">&times;</button>
        </div>
        <div class="noVNC_modern_panel_content">
          <textarea id="noVNC_modern_clipboard_text" rows="8" style="width:100%"></textarea>
          <button id="noVNC_modern_clipboard_send" class="noVNC_button">Send</button>
        </div>
      </div>
    </div>

    <!-- Modern Power Panel as Modal -->
    <div id="noVNC_modern_power_modal" class="noVNC_modal_backdrop">
      <div id="noVNC_modern_power" class="noVNC_modern_panel" tabindex="-1">
        <div class="noVNC_modern_panel_header">
          <span>Power</span>
          <button id="noVNC_modern_power_close" class="noVNC_modern_panel_close" aria-label="Close power">&times;</button>
        </div>
        <div class="noVNC_modern_panel_content">
          <button id="noVNC_modern_shutdown" class="noVNC_button">Shutdown</button>
          <button id="noVNC_modern_reboot" class="noVNC_button">Reboot</button>
          <button id="noVNC_modern_reset" class="noVNC_button">Reset</button>
        </div>
      </div>
    </div>

    <div id="noVNC_hint_anchor" class="noVNC_vcenter">
        <div id="noVNC_control_bar_hint">
        </div>
    </div>

    <!-- Status dialog -->
    <div id="noVNC_status"></div>

    <!-- Connect button -->
    <div class="noVNC_center">
        <div id="noVNC_connect_dlg">
            <div>
                <button id="noVNC_connect_button">
                    <img alt="" src="app/images/connect.svg"> Connect
                </button>
                <button id="noVNC_cancel_reconnect_button" style="display:none;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Server key verification dialog -->
    <div class="noVNC_center noVNC_connect_layer">
    <div id="noVNC_verify_server_dlg" class="noVNC_panel"><form>
        <div class="noVNC_heading">
            Server identity
        </div>
        <div>
            The server has provided the following identifying information:
        </div>
        <div id="noVNC_fingerprint_block">
            Fingerprint:
            <span id="noVNC_fingerprint"></span>
        </div>
        <div>
            Please verify that the information is correct and press
            "Approve". Otherwise press "Reject".
        </div>
        <div class="button_row">
            <input id="noVNC_approve_server_button" type="submit" value="Approve">
            <input id="noVNC_reject_server_button" type="button" value="Reject">
        </div>
    </form></div>
    </div>

    <!-- Password dialog -->
    <div class="noVNC_center noVNC_connect_layer">
    <div id="noVNC_credentials_dlg" class="noVNC_panel"><form>
        <div class="noVNC_heading">
            Credentials
        </div>
        <div id="noVNC_username_block">
            <label for="noVNC_username_input">Username:</label>
            <input id="noVNC_username_input">
        </div>
        <div id="noVNC_password_block">
            <label for="noVNC_password_input">Password:</label>
            <input id="noVNC_password_input" type="password">
        </div>
        <div class="button_row">
            <input id="noVNC_credentials_button" type="submit" value="Send credentials">
        </div>
    </form></div>
    </div>

    <!-- Transition screens -->
    <div id="noVNC_transition">
        <div class="loading_content">
            <div id="noVNC_tips">Pro Tip: Cloud PCs offer seamless collaboration with your team members across different time zones</div>
            <div id="noVNC_transition_text">Initializing connection...</div>
            <div class="loading-bar"></div>
        </div>
    </div>

    <audio id="noVNC_bell">
        <source src="app/sounds/bell.oga" type="audio/ogg">
        <source src="app/sounds/bell.mp3" type="audio/mpeg">
    </audio>

    <!-- LoudWave VNC Viewer Script -->
    <script src="app/vnc-script.js"></script>
    
    <!-- Integration bridge for LoudWave UI with noVNC -->
    <script>
        // Hide the LoudWave container overlay initially and show noVNC instead
        window.addEventListener('load', function() {
            const vncContainer = document.getElementById('vncContainer');
            const noVNCContainer = document.getElementById('noVNC_container');
            
            if (vncContainer) {
                vncContainer.style.display = 'none';
            }
            
            // Wire up LoudWave functions to handle noVNC connection status
            const originalResizeCanvas = window.resizeCanvas;
            window.resizeCanvas = function() {
                // Update when canvas is resized
                if (originalResizeCanvas) {
                    originalResizeCanvas();
                }
            };
        });
        
        // Custom wrapped functions for LoudWave UI buttons that integrate with noVNC
        window.toggleKeyboardLW = function() {
            const keyboard = document.getElementById('virtualKeyboard');
            keyboard.classList.toggle('active');
            
            if (navigator.vibrate) {
                navigator.vibrate(10);
            }
        };
        
        window.sendCtrlAltDelLW = function() {
            console.log('Sending Ctrl+Alt+Del via noVNC');
            
            // Send via noVNC if connected
            const rfb = window.rfb;
            if (rfb) {
                rfb.sendCtrlAltDel();
            }
            
            // Show feedback toast
            showToastLW('Ctrl+Alt+Del sent');
            
            if (navigator.vibrate) {
                navigator.vibrate(10);
            }
        };
        
        window.openInfoMenuLW = function() {
            const menu = document.getElementById('sideMenu');
            menu.classList.add('active');
            showPillLW();
            
            if (navigator.vibrate) {
                navigator.vibrate(10);
            }
        };
        
        window.closeInfoMenuLW = function() {
            const menu = document.getElementById('sideMenu');
            menu.classList.remove('active');
            
            if (navigator.vibrate) {
                navigator.vibrate(10);
            }
        };
        
        window.toggleFullscreenLW = function() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.log('Fullscreen error:', err);
                });
            } else {
                document.exitFullscreen();
            }
            
            if (navigator.vibrate) {
                navigator.vibrate(10);
            }
            
            showPillLW();
        };
        
        window.openQualitySettingsLW = function() {
            document.getElementById('qualityDialog').classList.add('active');
            showPillLW();
            
            if (navigator.vibrate) {
                navigator.vibrate(10);
            }
        };
        
        window.closeQualitySettingsLW = function() {
            document.getElementById('qualityDialog').classList.remove('active');
            
            if (navigator.vibrate) {
                navigator.vibrate(10);
            }
        };
        
        window.setQualityLW = function(quality) {
            const rfb = window.rfb;
            if (rfb) {
                // Map quality levels to compression settings
                const qualityMap = {
                    'high': 0,    // No compression for high quality
                    'medium': 6,  // Medium compression
                    'low': 9      // Maximum compression for low quality
                };
                
                rfb.preferredEncoding = 'tight';
                if (rfb.sendEncodings) {
                    // Update quality/compression based on noVNC settings
                    console.log('Quality set to:', quality);
                }
            }
            
            // Remove active class from all options
            document.querySelectorAll('.quality-option').forEach(option => {
                option.classList.remove('active');
            });
            
            // Add active class to selected option
            if (event && event.target) {
                event.target.closest('.quality-option').classList.add('active');
            }
            
            showToastLW(quality.charAt(0).toUpperCase() + quality.slice(1) + ' Quality selected');
            
            setTimeout(() => {
                closeQualitySettingsLW();
            }, 1000);
            
            if (navigator.vibrate) {
                navigator.vibrate(10);
            }
        };
        
        // Welcome dialog functions
        window.showWelcomeDialog = function() {
            console.log('Showing welcome dialog');
            const dialog = document.getElementById('welcomeDialog');
            if (dialog) {
                dialog.classList.add('active');
                console.log('Welcome dialog activated');
            } else {
                console.warn('Welcome dialog element not found');
            }
        };

        // New function specifically for on-connect welcome dialog (session-based)
        window.showWelcomeDialogOnConnect = function() {
            console.log('showWelcomeDialogOnConnect called');
            // Always show on connection (session-based, not persistent)
            const dialog = document.getElementById('welcomeDialog');
            if (dialog) {
                // Check if already shown in this session
                if (!dialog.hasAttribute('data-shown-this-session')) {
                    dialog.setAttribute('data-shown-this-session', 'true');
                    dialog.classList.add('active');
                    console.log('Welcome dialog shown for this session');
                }
            } else {
                console.warn('Welcome dialog element not found');
            }
        };
        
        window.closeWelcomeDialogLW = function() {
            const dialog = document.getElementById('welcomeDialog');
            if (dialog) {
                dialog.classList.remove('active');
            }
            // Remember that user has seen the welcome
            localStorage.setItem('loudwave_welcome_seen', 'true');
        };
        
        // Update ping indicator color based on latency
        window.updatePingIndicator = function(pingMs) {
            const indicator = document.getElementById('pingIndicator');
            const pingMsEl = document.getElementById('pingMs');
            
            if (!indicator) {
                console.warn('pingIndicator element not found');
                return;
            }
            
            console.log('Updating ping indicator:', pingMs);
            
            // Remove all ping classes
            indicator.classList.remove('ping-excellent', 'ping-good', 'ping-fair', 'ping-poor', 'ping-bad');
            
            // Update ping display
            if (pingMsEl) {
                if (pingMs === 999 || pingMs === null || isNaN(pingMs)) {
                    pingMsEl.textContent = '--ms';
                } else {
                    pingMsEl.textContent = pingMs + 'ms';
                }
            }
            
            // Add appropriate class based on latency
            if (pingMs === 999 || pingMs === null || isNaN(pingMs)) {
                // Unknown/error state
                indicator.classList.add('ping-poor');
            } else if (pingMs < 50) {
                indicator.classList.add('ping-excellent');
            } else if (pingMs < 100) {
                indicator.classList.add('ping-good');
            } else if (pingMs < 150) {
                indicator.classList.add('ping-fair');
            } else if (pingMs < 250) {
                indicator.classList.add('ping-poor');
            } else {
                indicator.classList.add('ping-bad');
            }
        };
        
        window.disconnectLW = function() {
            document.getElementById('disconnectDialog').classList.add('active');
            
            if (navigator.vibrate) {
                navigator.vibrate(10);
            }
        };
        
        window.closeDisconnectDialogLW = function() {
            document.getElementById('disconnectDialog').classList.remove('active');
            
            if (navigator.vibrate) {
                navigator.vibrate(10);
            }
        };
        
        window.confirmDisconnectLW = function() {
            const rfb = window.rfb;
            if (rfb) {
                rfb.disconnect();
            }
            
            if (navigator.vibrate) {
                navigator.vibrate(20);
            }
            
            closeDisconnectDialogLW();
            
            // Update connection status immediately on disconnect
            const connectionStatusEl = document.getElementById('connectionStatus');
            if (connectionStatusEl) {
                connectionStatusEl.textContent = 'Disconnected';
                connectionStatusEl.style.color = '#ff6b6b';
            }
            
            // Hide the pill when disconnecting
            const pill = document.getElementById('pillNav');
            if (pill) {
                pill.classList.remove('visible');
                pill.classList.add('hidden-completely');
            }
            
            setTimeout(() => {
                window.history.back();
            }, 500);
        };
        
        window.goBack = function() {
            if (navigator.vibrate) {
                navigator.vibrate(10);
            }
            window.history.back();
        };
        
        window.showStatsLW = function() {
            const rfb = window.rfb;
            let stats = 'Performance Stats:\n\nFPS: --\nLatency: --ms\nBandwidth: --\nPacket Loss: --\n\n';
            
            if (rfb && rfb.constructor.name === 'RFB') {
                // Could add real stats here from noVNC
            }
            
            alert(stats + '(Note: Connect to see live stats)');
            
            if (navigator.vibrate) {
                navigator.vibrate(10);
            }
        };
        
        window.showToastLW = function(message) {
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(30, 30, 50, 0.95);
                backdrop-filter: blur(20px);
                padding: 16px 24px;
                border-radius: 12px;
                border: 1px solid rgba(255, 255, 255, 0.1);
                color: white;
                font-size: 14px;
                z-index: 4000;
                animation: fadeIn 0.2s ease;
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.2s ease';
                setTimeout(() => toast.remove(), 200);
            }, 1500);
        };
        
        // Pill navigation control with updated name to avoid conflicts
        let pillTimeoutLW;
        let isPillVisibleLW = false;
        
        window.showPillLW = function(autoHideDelay) {
            // Only show if RFB is connected
            if (!window.rfb || !window.rfb.connected) {
                console.log('[Pill] Cannot show pill: RFB not connected');
                return;
            }
            
            const pill = document.getElementById('pillNav');
            const connectionStatusEl = document.getElementById('connectionStatus');
            
            if (!pill) return;
            
            console.log('[Pill] Showing pill');
            
            // Update connection status to show Connected when showing pill
            if (connectionStatusEl) {
                connectionStatusEl.textContent = 'Connected';
                connectionStatusEl.style.color = '#66ea9b';
            }
            
            // Ensure pill is visible
            pill.classList.remove('hidden-completely');
            pill.classList.add('visible');
            isPillVisibleLW = true;
            
            // Clear any existing timeout
            clearTimeout(pillTimeoutLW);
            
            // Only auto-hide if explicitly requested (with autoHideDelay param)
            // Otherwise pill stays visible until user hides it with Ctrl+V
            if (typeof autoHideDelay === 'number' && autoHideDelay > 0) {
                pillTimeoutLW = setTimeout(() => {
                    window.hidePillLW();
                }, autoHideDelay);
                console.log('[Pill] Will auto-hide after', autoHideDelay, 'ms');
            }
        };
        
        window.hidePillLW = function() {
            const pill = document.getElementById('pillNav');
            const keyboard = document.getElementById('virtualKeyboard');
            const menu = document.getElementById('sideMenu');
            
            if (!pill) return;
            
            // Don't hide if keyboard or menu is open
            if (keyboard && keyboard.classList.contains('active')) {
                return;
            }
            if (menu && menu.classList.contains('active')) {
                return;
            }
            
            // Remove visible class to trigger animation
            pill.classList.remove('visible');
            isPillVisibleLW = false;
            
            // Completely hide after animation completes
            setTimeout(() => {
                if (pill && !pill.classList.contains('visible')) {
                    pill.classList.add('hidden-completely');
                    // Update connection status to show Disconnected when hidden
                    const connectionStatusEl = document.getElementById('connectionStatus');
                    if (connectionStatusEl) {
                        connectionStatusEl.textContent = 'Disconnected';
                        connectionStatusEl.style.color = '#ff6b6b';
                    }
                }
            }, 400);
        };
        
        // Keyboard shortcut: Ctrl+V to show/hide pill
        document.addEventListener('keydown', function(e) {
            // Check for Ctrl+V (or Cmd+V on Mac)
            if ((e.ctrlKey || e.metaKey) && (e.key === 'v' || e.key === 'V')) {
                e.preventDefault();
                console.log('[Keyboard] Ctrl+V pressed');
                console.log('[Keyboard] RFB state:', window.rfb ? 'exists' : 'missing', window.rfb?.connected ? 'connected' : 'disconnected');
                
                const pill = document.getElementById('pillNav');
                if (!pill) {
                    console.warn('[Keyboard] Pill element not found');
                    return;
                }
                
                // Check actual classes to determine state
                const isHiddenCompletely = pill.classList.contains('hidden-completely');
                const isVisible = pill.classList.contains('visible');
                console.log('[Keyboard] Pill classes:', pill.className);
                console.log('[Keyboard] Hidden-completely:', isHiddenCompletely, 'Visible:', isVisible);
                
                // Toggle based on current state
                if (isHiddenCompletely || !isVisible) {
                    // Pill is hidden, show it
                    console.log('[Keyboard] Showing pill via Ctrl+V');
                    pill.classList.remove('hidden-completely');
                    pill.classList.add('visible');
                    window.isPillVisibleLW = true;
                    clearTimeout(window.pillTimeoutLW);
                } else {
                    // Pill is visible, hide it
                    console.log('[Keyboard] Hiding pill via Ctrl+V');
                    pill.classList.remove('visible');
                    window.isPillVisibleLW = false;
                    setTimeout(() => {
                        if (pill && !pill.classList.contains('visible')) {
                            pill.classList.add('hidden-completely');
                        }
                    }, 400);
                }
            }
        }, true); // Use capture phase to ensure it fires
        
        // Close menu when clicking outside
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('sideMenu');
            const pillNav = document.getElementById('pillNav');
            
            if (menu && menu.classList.contains('active') && 
                !menu.contains(e.target) && 
                !pillNav.contains(e.target)) {
                menu.classList.remove('active');
            }
        });
        
        // Close quality dialog when clicking outside
        const qualityDialog = document.getElementById('qualityDialog');
        if (qualityDialog) {
            qualityDialog.addEventListener('click', function(e) {
                if (e.target === this) {
                    closeQualitySettingsLW();
                }
            });
        }
        
        // Add CSS for toast animations if not already present
        if (!document.querySelector('style[data-toast-animations]')) {
            const style = document.createElement('style');
            style.setAttribute('data-toast-animations', 'true');
            style.textContent = `
                @keyframes fadeOut {
                    from { opacity: 1; }
                    to { opacity: 0; }
                }
                @keyframes fadeIn {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }
            `;
            document.head.appendChild(style);
        }
    </script>
 </body>
</html>
