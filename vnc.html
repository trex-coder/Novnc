<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>noVNC Modern UI</title>
  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background-color: #1e1e1e;
      color: #fff;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    header {
      background-color: #2c2c2c;
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 {
      margin: 0;
      font-size: 1.2rem;
    }
    .toolbar {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    .toolbar label, .toolbar select, .toolbar button {
      background: #444;
      color: #fff;
      border: none;
      padding: 0.4rem 0.6rem;
      border-radius: 4px;
      cursor: pointer;
    }
    .toolbar input[type=checkbox] {
      margin-right: 0.2rem;
    }
    .status {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: red;
    }
    .status-indicator.connected {
      background: #4caf50;
    }
    main {
      flex: 1;
      background-color: #000;
      position: relative;
    }
    #vnc-canvas {
      width: 100%;
      height: 100%;
      display: block;
    }
    #disconnected-screen {
      position: absolute;
      top: 0; left: 0;
      right: 0; bottom: 0;
      background-color: rgba(0,0,0,0.8);
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      color: #fff;
      z-index: 10;
    }
    footer {
      background: #2c2c2c;
      padding: 0.5rem;
      font-size: 0.85rem;
      text-align: center;
    }
  </style>
</head>
<body>
  <header>
    <h1>noVNC Modern UI</h1>
    <div class="status">
      <span id="status-indicator" class="status-indicator"></span>
      <span id="connection-status-text">Disconnected</span>
      <span style="margin-left: 1rem;">Host: <span id="host-value">-</span></span>
      <span>Port: <span id="port-value">-</span></span>
    </div>
  </header>

  <div class="toolbar" style="padding: 0.5rem;">
    <label><input type="checkbox" id="shared-toggle" checked> Shared</label>
    <label><input type="checkbox" id="viewonly-toggle"> View Only</label>
    <label><input type="checkbox" id="cliptowindow-toggle"> Clip to Window</label>
    <label><input type="checkbox" id="dotcursor-toggle" checked> Dot Cursor</label>
    <label>
      Scaling:
      <select id="scaling-mode">
        <option value="none">None</option>
        <option value="scale">Scale</option>
        <option value="remote">Remote Resize</option>
      </select>
    </label>
    <button id="disconnect-btn">Disconnect</button>
    <button id="reconnect-btn">Reconnect</button>
    <button id="ctrlaltdel-btn">Ctrl+Alt+Del</button>
    <button id="refresh-btn">Refresh</button>
    <button id="clipboard-btn">Clipboard</button>
    <button id="screenshot-btn">Screenshot</button>
  </div>

  <main id="vnc-canvas">
    <div id="disconnected-screen">
      <div class="disconnected-message">Disconnected</div>
      <div class="disconnected-submessage">Please check your connection or try reconnecting.</div>
    </div>
  </main>

  <footer>
    Powered by noVNC | Modern UI
  </footer>

  <!-- noVNC Integration Script -->
  <script type="module">
    // This is the integration script you provided, inserted directly
    // It assumes /novnc/core/rfb.js is accessible relative to server root
    document.addEventListener('DOMContentLoaded', function() {
      import("/novnc/core/rfb.js").then((RFBModule) => {
        const RFB = RFBModule.default;
        const urlParams = new URLSearchParams(window.location.search);
        let host = urlParams.get('host') || window.location.hostname;
        let port = urlParams.get('port') || window.location.port;
        let path = urlParams.get('path') || '';
        let scheme = window.location.protocol === "https:" ? "wss" : "ws";
        let url = `${scheme}://${host}:${port}/${path}`;
        const rfb = new RFB(document.getElementById('vnc-canvas'), url, {
          shared: document.getElementById('shared-toggle').checked,
          credentials: { password: urlParams.get('password') || "" }
        });
        rfb.addEventListener("connect", () => {
          document.getElementById('status-indicator').className = 'status-indicator connected';
          document.getElementById('connection-status-text').textContent = 'Connected';
          document.getElementById('disconnected-screen').style.display = 'none';
          document.getElementById('host-value').textContent = host;
          document.getElementById('port-value').textContent = port;
        });
        rfb.addEventListener("disconnect", (e) => {
          document.getElementById('status-indicator').className = 'status-indicator disconnected';
          document.getElementById('connection-status-text').textContent = 'Disconnected';
          document.getElementById('disconnected-screen').style.display = 'flex';
          console.log("Disconnected: " + e.detail.reason);
        });
        document.getElementById('viewonly-toggle').addEventListener('change', function() {
          rfb.viewOnly = this.checked;
        });
        document.getElementById('cliptowindow-toggle').addEventListener('change', function() {
          rfb.clipViewport = this.checked;
        });
        document.getElementById('scaling-mode').addEventListener('change', function() {
          switch (this.value) {
            case 'none':
              rfb.scaleViewport = false;
              rfb.resizeSession = false;
              break;
            case 'scale':
              rfb.scaleViewport = true;
              rfb.resizeSession = false;
              break;
            case 'remote':
              rfb.scaleViewport = false;
              rfb.resizeSession = true;
              break;
          }
        });
        document.getElementById('dotcursor-toggle').addEventListener('change', function() {
          rfb.showDotCursor = this.checked;
        });
        document.getElementById('disconnect-btn').addEventListener('click', function() {
          rfb.disconnect();
        });
        document.getElementById('reconnect-btn').addEventListener('click', function() {
          rfb.connect(url, { password: urlParams.get('password') || "" });
        });
        document.getElementById('ctrlaltdel-btn').addEventListener('click', function() {
          rfb.sendCtrlAltDel();
        });
        document.getElementById('refresh-btn').addEventListener('click', function() {
          rfb.sendKey(KeyTable.XK_F5, "ControlLeft");
        });
        document.getElementById('clipboard-btn').addEventListener('click', function() {
          const clipboardContent = prompt("Clipboard contents to send to the remote system:", "");
          if (clipboardContent !== null) {
            rfb.clipboardPasteFrom(clipboardContent);
          }
        });
        document.getElementById('screenshot-btn').addEventListener('click', function() {
          const canvas = document.querySelector('#vnc-canvas canvas');
          if (canvas) {
            try {
              const dataURL = canvas.toDataURL();
              const link = document.createElement('a');
              link.href = dataURL;
              link.download = 'screenshot-' + new Date().toISOString().replace(/[:.]/g, '-') + '.png';
              link.click();
            } catch (e) {
              console.error("Screenshot failed:", e);
              alert("Could not take screenshot. This may be due to security restrictions.");
            }
          }
        });
        rfb.viewOnly = document.getElementById('viewonly-toggle').checked;
        rfb.clipViewport = document.getElementById('cliptowindow-toggle').checked;
        rfb.showDotCursor = document.getElementById('dotcursor-toggle').checked;
        const scalingMode = document.getElementById('scaling-mode').value;
        rfb.scaleViewport = (scalingMode === 'scale');
        rfb.resizeSession = (scalingMode === 'remote');
        window.addEventListener('resize', function() {
          if (this.resizeTimeout) clearTimeout(this.resizeTimeout);
          this.resizeTimeout = setTimeout(function() {
            if (rfb.scaleViewport || rfb.resizeSession) {
              rfb._windowResize();
            }
          }, 500);
        });
        console.log("noVNC initialized and connected to " + url);
      }).catch(err => {
        console.error("Failed to load noVNC modules:", err);
        document.getElementById('status-indicator').className = 'status-indicator disconnected';
        document.getElementById('connection-status-text').textContent = 'Error loading noVNC';
        document.getElementById('disconnected-screen').style.display = 'flex';
        document.querySelector('.disconnected-message').textContent = 'Error Loading noVNC';
        document.querySelector('.disconnected-submessage').textContent = 'Could not initialize the VNC client. Please check the console for errors.';
      });
    });
  </script>
</body>
</html>
